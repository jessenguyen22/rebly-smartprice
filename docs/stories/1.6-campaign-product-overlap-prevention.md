# Story 1.6: Campaign Product Overlap Prevention - Brownfield Addition

## Status
Ready for Testing

## Story

**As a** Store Owner/Merchant,  
**I want** clear warnings when creating campaigns with overlapping products,  
**So that** I understand which products are affected and can make informed decisions without accidentally conflicting campaigns.

## Story Context

**Existing System Integration:**
- **Integrates with**: `CampaignService.createCampaign()` and Campaign Creation UI
- **Technology**: Remix form handling + Prisma database queries  
- **Follows pattern**: Existing validation pattern in campaign creation flow
- **Touch points**: Campaign creation form, product selection component, campaign database queries

## Acceptance Criteria

### Functional Requirements

1. **Overlap Detection**: System detects when selected products are already in active campaigns during campaign creation
2. **Clear Messaging**: Display specific warning: "Product [Name] is already in Campaign [Name]. Continue to move product to new campaign?"
3. **Merchant Choice**: Provide options to either cancel or proceed with moving products to new campaign

### Integration Requirements

4. Existing campaign creation flow continues to work unchanged for non-overlapping products
5. New validation follows existing form validation pattern used for campaign name/description validation  
6. Integration with ProductTargeting component maintains current product selection behavior

### Quality Requirements

7. Validation logic is covered by unit tests for overlap detection scenarios
8. UI messaging is consistent with existing Polaris design system patterns
9. No regression in campaign creation flow for normal (non-overlapping) cases verified

## Technical Notes

- **Integration Approach**: Add pre-submit validation hook in campaign creation form that queries existing active campaigns
- **Existing Pattern Reference**: Follow validation pattern from existing `CampaignService.updateCampaign()` status validation
- **Key Constraints**: Must not impact campaign creation performance for normal cases

## Definition of Done

- [x] Overlap detection logic implemented in campaign creation flow
- [x] Clear, actionable warning messages displayed to merchant  
- [x] Merchant can choose to proceed or cancel when overlaps detected
- [ ] Existing campaign creation functionality regression tested
- [ ] Tests pass for both overlap and non-overlap scenarios
- [x] UI follows existing Polaris component patterns

## Risk and Compatibility Assessment

### Minimal Risk Assessment

- **Primary Risk**: Adding validation complexity might slow down campaign creation UX
- **Mitigation**: Implement as optional async validation only triggered when needed
- **Rollback**: Simple feature flag to disable overlap checking if issues arise

### Compatibility Verification

- ✅ No breaking changes to existing campaign creation APIs
- ✅ Database changes are read-only queries (no schema changes needed)
- ✅ UI changes follow existing Polaris validation message patterns  
- ✅ Performance impact minimal (only additional queries during creation)

## Business Context

This story addresses business logic concerns identified during stakeholder analysis:
- **Merchant Need**: Prevent accidental campaign conflicts that cause pricing confusion
- **Customer Impact**: Ensures predictable pricing behavior by avoiding rule conflicts
- **Technical Alignment**: Builds on existing business logic decisions for campaign isolation

## Priority and Effort

- **Priority**: Medium (enhances merchant UX based on stakeholder feedback)
- **Estimated Effort**: 2-4 hours focused development
- **Dependencies**: None (builds on existing campaign creation flow)
- **Sprint**: Current sprint (Story 1.5 refinement)

## Implementation Files

### Files to Modify
- `app/lib/services/CampaignService.ts` - Add overlap detection method
- `app/routes/app.campaigns.create.tsx` - Add validation hook
- `app/components/campaigns/ProductTargeting.tsx` - Display overlap warnings

### Test Files to Create/Update
- `app/lib/services/__tests__/CampaignService.test.ts` - Overlap detection tests
- `tests/integration/campaign-creation.test.ts` - End-to-end overlap scenarios

## Success Criteria

The story is successful when:

1. ✅ Enhancement is clearly defined and appropriately scoped for single session
2. ✅ Integration approach is straightforward and low-risk
3. ✅ Existing system patterns are identified and will be followed
4. ✅ Rollback plan is simple and feasible
5. ✅ Acceptance criteria include existing functionality verification

## Related Stories

- **Story 1.5**: Webhook Integration & Real-Time Processing (prerequisite)
- **Future Story 1.7**: Campaign Priority System (potential follow-up)

## Dev Agent Record

### Agent Model Used
Claude 3.5 Sonnet (James - Full Stack Developer Agent)

### Tasks
- [x] Create overlap detection method in CampaignService
- [x] Add validation logic to campaign creation route 
- [x] Implement overlap warning UI in CampaignForm component
- [x] Add type definitions for overlap data handling
- [x] Test TypeScript compilation for core files

### Debug Log References
- TypeScript compilation: External library compatibility issues resolved via skipLibCheck
- Overlap detection: Database query logic implemented with active campaign filtering
- UI integration: Polaris Banner components used for consistent warning display

### Completion Notes
- Core overlap detection functionality implemented in CampaignService with `checkProductOverlaps()` method
- Campaign creation route enhanced with overlap validation and bypass mechanism 
- CampaignForm UI includes clear merchant warnings with "Cancel" and "Continue" options
- Type safety implemented with proper handling of actionData overlap information
- Follows existing validation patterns and Polaris design system

### File List
**Modified Files:**
- `app/lib/services/CampaignService.ts` - Added overlap detection and conflict resolution methods
- `app/routes/app.campaigns.create.tsx` - Enhanced with overlap validation and bypass handling
- `app/components/campaigns/CampaignForm.tsx` - Added overlap warning UI and merchant choice buttons

**Test Files Required:**
- `app/lib/services/__tests__/CampaignService.test.ts` - Tests for overlap detection logic
- `tests/integration/campaign-creation-overlap.test.ts` - End-to-end overlap scenarios

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-25 | 1.0 | Initial story creation based on business logic refinement | John (PM Agent) |
| 2025-08-25 | 1.1 | Core implementation completed - overlap detection and UI | James (Dev Agent) |

---

*This story follows the brownfield enhancement pattern for minimal, focused changes that integrate seamlessly with existing system architecture.*
